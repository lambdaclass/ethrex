.PHONY: deps setup

ETHREX_HOME=$(shell pwd)/ethrex
ETHREX_L2_HOME=$(ETHREX_HOME)/crates/l2

ETHREX_REPO=https://github.com/lambdaclass/ethrex.git

SOLC_VERSION=v0.8.29

# pkg-config libssl libclang-dev

deps:
	sudo apt update && sudo apt install -y libclang-dev
	# docker
	curl -fsSL https://get.docker.com -o get-docker.sh
	sh get-docker.sh
	# rust
	curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
	. "$(HOME)/.cargo/env"
	# solc
	if [ "$(shell uname -s)" = "Darwin" ]; then \
		echo "Downloading solc for MacOS"; \
		sudo curl -L -o /usr/bin/solc "https://github.com/ethereum/solidity/releases/download/${SOLC_VERSION}/solc-macos"; \
		sudo chmod +x /usr/bin/solc; \
	elif [ "$(shell uname -s)" = "Linux" ]; then \
		echo "Downloading solc for Linux"; \
		sudo curl -L -o /usr/bin/solc "https://github.com/ethereum/solidity/releases/download/${SOLC_VERSION}/solc-static-linux"; \
		sudo chmod +x /usr/bin/solc; \
	fi
	# rex
	cargo install --git https://github.com/lambdaclass/rex
	# Check if deps were installed correctly.
	if [ "$(shell cargo --version | echo $$?)" != "0" ]; then \
		echo "Failed to download cargo, there's a bug in the Makefile"; \
	fi
	# Check solc was installed correctly.
	if [ "$(shell solc | echo $$?)" != "0" ]; then \
		echo "Failed to download solc, there's a bug in the Makefile"; \
	fi

setup:
	# ethrex
	git -C ${ETHREX_HOME} pull origin main --ff-only 2>/dev/null || git clone ${ETHREX_REPO} ${ETHREX_HOME}

init:
	make -C ${ETHREX_L2_HOME} init-testnet

L2_GENESIS_FILE_PATH=$(ETHREX_HOME)/test_data/genesis-l2.json
L2_PORT=1729
L2_AUTH_PORT=8552
L2_PROMETHEUS_METRICS_PORT = 3702
L2_DB_DIR=ethrex_l2

# FIXME: temporary solution until we fix the bash version issue.
# Right now, ethrex L2's `init-l2` does not work on this server.
# Run this after the above `init` fails at ethrex L2's `init-l2`.
init-l2:
	ENV_FILE=${ETHREX_L2_HOME}/.env cargo run --release --manifest-path ${ETHREX_HOME}/Cargo.toml --bin ethrex --features "metrics,l2" -- \
		--network ${L2_GENESIS_FILE_PATH} \
		--http.port ${L2_PORT} \
		--http.addr 0.0.0.0 \
		--authrpc.port ${L2_AUTH_PORT} \
		--metrics.port ${L2_PROMETHEUS_METRICS_PORT} \
		--datadir ${L2_DB_DIR}

restart:
	# TODO: Replace the above with this after having this target on main
	# make -C ${ETHREX_L2_HOME} restart-testnet

explorer:
	sh ethrex-explorer/deploy_blockscout.sh

explorer-deps:
	# Libs
	sudo apt update && sudo apt install -y tmux build-essential pkg-config libssl-dev libclang-dev libgmp3-dev jq autoconf m4 libncurses5-dev libgl1-mesa-dev libglu1-mesa-dev libssh-dev unixodbc-dev
	# docker
	curl -fsSL https://get.docker.com -o get-docker.sh
	sh get-docker.sh
	# rust
	curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
	. "$(HOME)/.cargo/env"
	# ASDF
	git -C ~/.asdf pull origin v0.14.1 --ff-only || git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.14.1
	. "$(HOME)/.asdf/asdf.sh"
	. "$(HOME)/.asdf/completions/asdf.bash"

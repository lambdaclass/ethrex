- name: Metrics Setup
  hosts: metrics

  vars:
    ansible_ssh_user: admin
    ethrex_dir: "/home/{{ ansible_user }}/ethrex"
    local_grafana_dashboards: "{{ playbook_dir }}/../crates/blockchain/metrics/provisioning/grafana_provisioning/"
    remote_grafana_dashboards: "/etc/grafana/provisioning/"
    grafana_alerts:
      - name: alerts
        path: "{{ ethrex_dir }}/crates/blockchain/metrics/provisioning/grafana_provisioning/alerting"

  tasks:
    - name: Install rsync
      become: true
      apt:
        name:
          - rsync
        state: present

    - name: Enable SSH agent forwarding
      become: true
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?AllowAgentForwarding.*'
        line: 'AllowAgentForwarding yes'
        state: present

    - name: Restart SSH service
      become: true
      systemd:
        name: sshd
        state: restarted

    - name: Reset connection
      meta: reset_connection

    - name: Check if Grafana is installed
      stat:
        path: /usr/sbin/grafana-server
      register: grafana

    - name: Clone monitoring stack repository
      git:
        repo: "git@github.com:lambdaclass/monitoring-stack.git"
        dest: /home/{{ ansible_user}}/monitoring-stack
        version: main
        accept_hostkey: true
      when: not grafana.stat.exists

    - name: Add localhost as known hosts
      shell: ssh-keyscan localhost >> /home/{{ ansible_user }}/.ssh/known_hosts
      when: not grafana.stat.exists

    - name: Install ansible on server
      become: true
      apt:
        name: ansible
        state: present
      when: not grafana.stat.exists

    - name: Run monitoring stack deployment
      make:
        chdir: /home/{{ ansible_user }}/monitoring-stack
        target: all
        params:
          GRAFANA_PASSWORD: "{{ lookup('env', 'GRAFANA_PASSWORD') }}"
          TARGET: localhost
      when: not grafana.stat.exists

    - name: Synchronize Grafana dashboards (recursive copy of all folders and files)
      become: true
      synchronize:
        src: "{{ local_grafana_dashboards }}{{ item.path }}"
        dest: "{{ remote_grafana_dashboards }}{{ item.path }}"
        rsync_opts:
          - "-avz"
      loop:
        - name: l1_dashboards
          path: "dashboards/"
        - name: l2_dashboards
          path: "dashboards/l2_dashboards/"
        - name: common_dashboards
          path: "dashboards/common_dashboards/"

    - name: Update grafana provisioning for dashboards
      become: true
      template:
        src: templates/config/dashboards.yml.j2
        dest: /etc/grafana/provisioning/dashboards/dashboards.yml
        owner: grafana
        group: grafana
        mode: '0644'
      vars:
        grafana_dashboards:
          - name: l1_dashboards
            path: "{{ remote_grafana_dashboards }}"
          - name: l2_dashboards
            path: "{{ remote_grafana_dashboards }}l2_dashboards/"
          - name: common_dashboards
            path: "{{ remote_grafana_dashboards }}common_dashboards/"

    - name: Remove ProtectHome=true from grafana-server.service
      become: true
      lineinfile:
        path: /lib/systemd/system/grafana-server.service
        regexp: '^\s*ProtectHome\s*=\s*true\s*$'
        state: absent

    - name: Check if uid exists in Prometheus datasource
      lineinfile:
        path: /etc/grafana/provisioning/datasources/prometheus.yaml
        regexp: '^\s*uid:\s*prom-001\s*$'
        state: absent
      check_mode: yes
      register: uid_check
      changed_when: false

    - name: Add UID below type in Prometheus datasource
      become: true
      lineinfile:
        path: /etc/grafana/provisioning/datasources/prometheus.yaml
        regexp: '^(\s*)type:\s*prometheus\s*$'
        line: '\1type: prometheus\n\1uid: prom-001'
        backrefs: yes
      when: uid_check.found == 0

    - name: Add Ethereum Metrics Exporter scrape config
      become: true
      blockinfile:
        path: /etc/prometheus/prometheus.yml
        insertafter: "scrape_configs:"
        block: |
          {{ text | indent(2, first=true) }}
        state: present
      vars:
        text: |
          - job_name: 'ethereum_metrics_exporter'
            static_configs:
              - targets: ['localhost:8081']

    - name: Add alerts
      become: true
      template:
        src: templates/config/grafana.ini.j2
        dest: /etc/grafana/grafana.ini
        owner: grafana
        group: grafana
        mode: '0644'

    - name: Restart Grafana
      become: true
      systemd:
        name: grafana-server
        state: restarted
        daemon_reload: true

    - name: Remove monitoring stack repo
      file:
        path: /home/{{ ansible_user }}/monitoring-stack
        state: absent

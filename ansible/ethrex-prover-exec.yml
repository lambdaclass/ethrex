- name: Ethrex Prover Exec
  hosts: prover_exec
  vars:
    ansible_ssh_user: app
    ethrex_dir: "/home/{{ ansible_user }}/ethrex"
    ethrex_version: "l2_v0.0.1-rc1"

  tasks:
    - name: Make directories
      file:
        path: "{{ ethrex_dir }}/bin"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0700"

    - name: Download ethrex prover exec
      get_url:
        url: https://github.com/lambdaclass/ethrex/releases/download/{{ ethrex_version }}/ethrex_prover_exec-linux_{{ ansible_architecture }}
        dest: "{{ ethrex_dir }}/bin/ethrex_prover"
        mode: "0744"

    - name: Ensure user systemd directory exists
      file:
        path: "/home/{{ ansible_user }}/.config/systemd/user"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0700"

    - name: Install ethrex prover exec service
      template:
        src: services/ethrex-prover.service.j2
        dest: /home/{{ ansible_user }}/.config/systemd/user/ethrex-prover.service
      vars:
        ethrex_sequencer_address: "{{ lookup('env', 'ETHREX_SEQUENCER_ADDRESS', default='127.0.0.1') }}"
        ethrex_sequencer_port: "{{ lookup('env', 'ETHREX_SEQUENCER_PORT', default='3900') }}"

    - name: Start ethrex prover exec
      systemd:
        name: ethrex-prover
        state: started
        enabled: true
        daemon_reload: true
        scope: user

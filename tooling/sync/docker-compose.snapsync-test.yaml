# Test compose: 2 hoodi instances running in parallel
# Usage:
#   docker compose -f docker-compose.snapsync-test.yaml up -d
#   docker compose -f docker-compose.snapsync-test.yaml logs -f
#   docker compose -f docker-compose.snapsync-test.yaml down -v

x-ethrex-common: &ethrex-common
  image: "ghcr.io/lambdaclass/ethrex:main"
  pull_policy: always
  ulimits:
    nofile: 1000000
  restart: unless-stopped

x-lighthouse-common: &lighthouse-common
  image: sigp/lighthouse:v8.0.1
  restart: unless-stopped

services:
  # =============================================================================
  # HOODI INSTANCE 1
  # =============================================================================
  setup-jwt-hoodi-1:
    image: alpine
    volumes:
      - secrets-hoodi-1:/secrets
    command: sh -c 'apk add openssl && openssl rand -hex 32 | tr -d "\n" | tee /secrets/jwt.hex'

  lighthouse-hoodi-1:
    <<: *lighthouse-common
    container_name: lighthouse-hoodi-1
    volumes:
      - secrets-hoodi-1:/secrets
      - lighthouse-hoodi-1:/root/.lighthouse
    command: >
      lighthouse bn
      --network hoodi
      --http --http-address 0.0.0.0
      --execution-endpoint http://ethrex-hoodi-1:8551
      --execution-jwt /secrets/jwt.hex
      --checkpoint-sync-url https://hoodi-checkpoint-sync.stakely.io/
      --checkpoint-sync-url-timeout 600
      --purge-db
    depends_on:
      setup-jwt-hoodi-1:
        condition: service_completed_successfully

  ethrex-hoodi-1:
    <<: *ethrex-common
    container_name: ethrex-hoodi-1
    ports:
      - "8545:8545"
    volumes:
      - secrets-hoodi-1:/secrets
      - ethrex-hoodi-1:/data
    command: >
      --http.addr 0.0.0.0
      --network hoodi
      --authrpc.addr 0.0.0.0
      --authrpc.jwtsecret /secrets/jwt.hex
      --syncmode snap
      --datadir /data
    depends_on:
      setup-jwt-hoodi-1:
        condition: service_completed_successfully

  # =============================================================================
  # HOODI INSTANCE 2
  # =============================================================================
  setup-jwt-hoodi-2:
    image: alpine
    volumes:
      - secrets-hoodi-2:/secrets
    command: sh -c 'apk add openssl && openssl rand -hex 32 | tr -d "\n" | tee /secrets/jwt.hex'

  lighthouse-hoodi-2:
    <<: *lighthouse-common
    container_name: lighthouse-hoodi-2
    volumes:
      - secrets-hoodi-2:/secrets
      - lighthouse-hoodi-2:/root/.lighthouse
    command: >
      lighthouse bn
      --network hoodi
      --http --http-address 0.0.0.0
      --execution-endpoint http://ethrex-hoodi-2:8551
      --execution-jwt /secrets/jwt.hex
      --checkpoint-sync-url https://hoodi-checkpoint-sync.stakely.io/
      --checkpoint-sync-url-timeout 600
      --purge-db
    depends_on:
      setup-jwt-hoodi-2:
        condition: service_completed_successfully

  ethrex-hoodi-2:
    <<: *ethrex-common
    container_name: ethrex-hoodi-2
    ports:
      - "8546:8545"
    volumes:
      - secrets-hoodi-2:/secrets
      - ethrex-hoodi-2:/data
    command: >
      --http.addr 0.0.0.0
      --network hoodi
      --authrpc.addr 0.0.0.0
      --authrpc.jwtsecret /secrets/jwt.hex
      --syncmode snap
      --datadir /data
    depends_on:
      setup-jwt-hoodi-2:
        condition: service_completed_successfully

volumes:
  secrets-hoodi-1:
  secrets-hoodi-2:
  lighthouse-hoodi-1:
  lighthouse-hoodi-2:
  ethrex-hoodi-1:
  ethrex-hoodi-2:

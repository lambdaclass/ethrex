services:
  setup_jwt:
    image: alpine
    volumes:
      - secrets:/secrets
    command: sh -c 'apk add openssl && openssl rand -hex 32 | tr -d "\n" | tee /secrets/jwt.hex'

  lighthouse:
    container_name: lighthouse
    image: sigp/lighthouse
    ports:
      - "9000:9000/tcp"
      - "9000:9000/udp"
      - "9001:9001/udp"
      - 127.0.0.1:5052:5052
    volumes:
      - secrets:/secrets
    command: >
      lighthouse
      --network hoodi
      beacon
      --http
      --http-address 0.0.0.0
      --execution-endpoint http://ethrex:8551
      --execution-jwt /secrets/jwt.hex
      --checkpoint-sync-url https://hoodi-checkpoint-sync.attestant.io
      --checkpoint-sync-url-timeout 600
    depends_on:
      setup_jwt:
        condition: service_completed_successfully

  ethrex:
    container_name: ethrex
    image: "ethrex:unstable"
    build: ../../
    ports:
      - 127.0.0.1:8545:8545
      - "30303:30303/tcp"
      - "30303:30303/udp"
    volumes:
      - secrets:/secrets
    environment:
      - RUST_LOG=ethrex_p2p::rlpx::eth::blocks=off,ethrex_p2p::sync=debug,ethrex_p2p::network=info,spawned_concurrency::tasks::gen_server=off
    command: >
      --http.addr 0.0.0.0
      --authrpc.addr 0.0.0.0
      --network hoodi
      --authrpc.jwtsecret /secrets/jwt.hex
      --syncmode snap
    depends_on:
      setup_jwt:
        condition: service_completed_successfully

volumes:
  secrets:

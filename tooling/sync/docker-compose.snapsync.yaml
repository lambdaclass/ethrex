# Multi-network parallel snapsync
# Usage:
#   docker compose -f docker-compose.snapsync.yaml up -d
#   docker compose -f docker-compose.snapsync.yaml logs -f
#   docker compose -f docker-compose.snapsync.yaml down -v
#
# Each network runs in isolation with its own volumes.
# Host ports are mapped for external RPC access:
#   hoodi:   localhost:8545
#   sepolia: localhost:8546
#   mainnet: localhost:8547

x-ethrex-common: &ethrex-common
  image: "ghcr.io/lambdaclass/ethrex:main"
  pull_policy: always
  ulimits:
    nofile: 1000000
  restart: unless-stopped

x-consensus-common: &consensus-common
  image: sigp/lighthouse:v8.0.1
  restart: unless-stopped

services:
  # =============================================================================
  # HOODI
  # =============================================================================
  setup-jwt-hoodi:
    image: alpine
    volumes:
      - secrets-hoodi:/secrets
    command: sh -c 'apk add openssl && openssl rand -hex 32 | tr -d "\n" | tee /secrets/jwt.hex'

  consensus-hoodi:
    <<: *consensus-common
    container_name: consensus-hoodi
    volumes:
      - secrets-hoodi:/secrets
      - consensus-hoodi:/root/.lighthouse
    command: >
      lighthouse bn
      --network hoodi
      --http --http-address 0.0.0.0
      --execution-endpoint http://ethrex-hoodi:8551
      --execution-jwt /secrets/jwt.hex
      --checkpoint-sync-url https://hoodi-checkpoint-sync.stakely.io/
      --checkpoint-sync-url-timeout 600
      --purge-db
    depends_on:
      setup-jwt-hoodi:
        condition: service_completed_successfully

  ethrex-hoodi:
    <<: *ethrex-common
    container_name: ethrex-hoodi
    ports:
      - "8545:8545"  # RPC
    volumes:
      - secrets-hoodi:/secrets
      - ethrex-hoodi:/data
    command: >
      --http.addr 0.0.0.0
      --network hoodi
      --authrpc.addr 0.0.0.0
      --authrpc.jwtsecret /secrets/jwt.hex
      --syncmode snap
      --datadir /data
    depends_on:
      setup-jwt-hoodi:
        condition: service_completed_successfully

  # =============================================================================
  # SEPOLIA
  # =============================================================================
  setup-jwt-sepolia:
    image: alpine
    volumes:
      - secrets-sepolia:/secrets
    command: sh -c 'apk add openssl && openssl rand -hex 32 | tr -d "\n" | tee /secrets/jwt.hex'

  consensus-sepolia:
    <<: *consensus-common
    container_name: consensus-sepolia
    volumes:
      - secrets-sepolia:/secrets
      - consensus-sepolia:/root/.lighthouse
    command: >
      lighthouse bn
      --network sepolia
      --http --http-address 0.0.0.0
      --execution-endpoint http://ethrex-sepolia:8551
      --execution-jwt /secrets/jwt.hex
      --checkpoint-sync-url https://checkpoint-sync.sepolia.ethpandaops.io
      --checkpoint-sync-url-timeout 600
      --purge-db
    depends_on:
      setup-jwt-sepolia:
        condition: service_completed_successfully

  ethrex-sepolia:
    <<: *ethrex-common
    container_name: ethrex-sepolia
    ports:
      - "8546:8545"  # RPC on different host port
    volumes:
      - secrets-sepolia:/secrets
      - ethrex-sepolia:/data
    command: >
      --http.addr 0.0.0.0
      --network sepolia
      --authrpc.addr 0.0.0.0
      --authrpc.jwtsecret /secrets/jwt.hex
      --syncmode snap
      --datadir /data
    depends_on:
      setup-jwt-sepolia:
        condition: service_completed_successfully

  # =============================================================================
  # MAINNET
  # =============================================================================
  setup-jwt-mainnet:
    image: alpine
    volumes:
      - secrets-mainnet:/secrets
    command: sh -c 'apk add openssl && openssl rand -hex 32 | tr -d "\n" | tee /secrets/jwt.hex'

  consensus-mainnet:
    <<: *consensus-common
    container_name: consensus-mainnet
    volumes:
      - secrets-mainnet:/secrets
      - consensus-mainnet:/root/.lighthouse
    command: >
      lighthouse bn
      --network mainnet
      --http --http-address 0.0.0.0
      --execution-endpoint http://ethrex-mainnet:8551
      --execution-jwt /secrets/jwt.hex
      --checkpoint-sync-url https://mainnet-checkpoint-sync.attestant.io
      --checkpoint-sync-url-timeout 600
      --purge-db
    depends_on:
      setup-jwt-mainnet:
        condition: service_completed_successfully

  ethrex-mainnet:
    <<: *ethrex-common
    container_name: ethrex-mainnet
    ports:
      - "8547:8545"  # RPC on different host port
    volumes:
      - secrets-mainnet:/secrets
      - ethrex-mainnet:/data
    command: >
      --http.addr 0.0.0.0
      --network mainnet
      --authrpc.addr 0.0.0.0
      --authrpc.jwtsecret /secrets/jwt.hex
      --syncmode snap
      --datadir /data
    depends_on:
      setup-jwt-mainnet:
        condition: service_completed_successfully

volumes:
  secrets-hoodi:
  secrets-sepolia:
  secrets-mainnet:
  consensus-hoodi:
  consensus-sepolia:
  consensus-mainnet:
  ethrex-hoodi:
  ethrex-sepolia:
  ethrex-mainnet:

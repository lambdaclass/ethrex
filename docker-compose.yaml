services:
  setup_jwt:
    image: alpine
    volumes:
      - secrets:/secrets
    command: sh -c 'apk add openssl && openssl rand -hex 32 | tr -d "\n" | tee /secrets/jwt.hex'

  lighthouse:
    container_name: lighthouse
    image: sigp/lighthouse
    ports:
      - "9000:9000/tcp"
      - "9000:9000/udp"
      - "9001:9001/udp"
      - 127.0.0.1:5052:5052
    volumes:
      - secrets:/secrets
      - lighthouse:/root/.lighthouse
    command: >
      lighthouse
      --network ${ETHREX_NETWORK:-mainnet}
      beacon
      --http
      --http-address 0.0.0.0
      --execution-endpoint http://ethrex:8551
      --execution-jwt /secrets/jwt.hex
      --checkpoint-sync-url https://${ETHREX_NETWORK:-mainnet}-checkpoint-sync.attestant.io
      --checkpoint-sync-url-timeout 600
    depends_on:
      setup_jwt:
        condition: service_completed_successfully

  ethrex:
    container_name: ethrex
    image: "ghcr.io/lambdaclass/ethrex:main"
    pull_policy: always
    platform: linux/amd64
    ports:
      - 127.0.0.1:8545:8545
    volumes:
      - secrets:/secrets
      - ethrex:/data
    command: >
      --http.addr 0.0.0.0
      --network ${ETHREX_NETWORK:-mainnet}
      --authrpc.addr 0.0.0.0
      --authrpc.jwtsecret /secrets/jwt.hex
      --syncmode snap
      --datadir /data
    ulimits:
      nofile: 1000000
    depends_on:
      setup_jwt:
        condition: service_completed_successfully

volumes:
  secrets:
  lighthouse:
  ethrex:

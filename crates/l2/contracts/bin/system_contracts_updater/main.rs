use std::{collections::HashMap, path::Path, path::PathBuf};

use bytes::Bytes;
use clap::Parser;
use cli::SystemContractsUpdaterOptions;
use error::SystemContractsUpdaterError;
use ethrex_common::U256;
use ethrex_common::types::GenesisAccount;
use ethrex_l2::utils::test_data_io::read_genesis_file;
use ethrex_l2_sdk::{COMMON_BRIDGE_L2_ADDRESS, L2_TO_L1_MESSENGER_ADDRESS};
use genesis_tool::genesis::write_genesis_as_json;
mod cli;
mod error;

/// Bytecode of the CommonBridgeL2 contract.
/// This is generated by the [build script](./build.rs).
const COMMON_BRIDGE_L2_RUNTIME: &[u8] = include_bytes!(concat!(
    env!("OUT_DIR"),
    "/contracts/solc_out/CommonBridgeL2.bytecode"
));

/// Bytecode of the L2ToL1Messenger contract.
/// This is generated by the [build script](./build.rs).
const L2_TO_L1_MESSENGER_RUNTIME: &[u8] = include_bytes!(concat!(
    env!("OUT_DIR"),
    "/contracts/solc_out/L2ToL1Messenger.bytecode"
));

fn main() -> Result<(), SystemContractsUpdaterError> {
    let opts = SystemContractsUpdaterOptions::parse();
    update_genesis_file(&opts.l2_genesis_path)?;
    Ok(())
}

fn update_genesis_file(l2_genesis_path: &PathBuf) -> Result<(), SystemContractsUpdaterError> {
    let mut genesis = read_genesis_file(l2_genesis_path.to_str().ok_or(
        SystemContractsUpdaterError::InvalidPath(
            "Failed to convert l2 genesis path to string".to_string(),
        ),
    )?);

    genesis.alloc.insert(
        COMMON_BRIDGE_L2_ADDRESS,
        GenesisAccount {
            code: Bytes::from(COMMON_BRIDGE_L2_RUNTIME.to_vec()),
            storage: HashMap::new(),
            balance: U256::zero(),
            nonce: 1,
        },
    );

    genesis.alloc.insert(
        L2_TO_L1_MESSENGER_ADDRESS,
        GenesisAccount {
            code: Bytes::from(L2_TO_L1_MESSENGER_RUNTIME.to_vec()),
            storage: HashMap::new(),
            balance: U256::zero(),
            nonce: 1,
        },
    );

    write_genesis_as_json(genesis, Path::new(l2_genesis_path)).map_err(std::io::Error::other)?;

    println!("Updated L2 genesis file.");

    Ok(())
}

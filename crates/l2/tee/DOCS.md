# TDX execution module

## Usage

On a machine with TDX support [with the required setup](https://github.com/canonical/tdx) run
```
mkosi build
mkosi vm
```

## What is TDX?

TDX is an Intel technology implementing a Trusted Execution Environment.
Such an environment allows verifying certain code was executed without being tampered with or observed.

These verifications (attestations) are known as "quotes" and contain signatures verifying the attestation was generated by a genuine processor, the measurements at the time, and a user-provided piece of data binding the proof.

The measurements happen into four Run Time Measurement Registers (RTMR), with each RTMR respresenting a boot stage.
This is analogous to [how PCRs work](https://uapi-group.org/specifications/specs/linux_tpm_pcr_registry/).

## Usage considerations

Do not hardcode quote verification parameters as [they might change](https://cc-enabling.trustedservices.intel.com/intel-tdx-enabling-guide/02/infrastructure_setup/#tcb-recovery-tcb-r).

It's easy to silently overlook non-verified areas such as accidentally leaving login enabled, not verifying the integrity of the state.

## Boot sequence

- Firmware (OVMF here) is loaded (and hashed into RTMR[0])
- [UKI](https://uapi-group.org/specifications/specs/unified_kernel_image/) is loaded (and hashed into a RTMR)
- kernel and initrd are extracted from the UKI and executed
- root partition is verified using the `roothash=` value provided on the kernel cmdline and the `hash` partition with the dm-verity merkle tree
- root partition is mounted read-only
- (WIP) systemd executes the payload

## Image build components

To build images we use [mkosi](https://github.com/systemd/mkosi)

### Tooling image

`mkosi.tools.conf` defines the tool configuration, and `mkosi.tools.skeleton` imports the kobuk-team PPA (used by [canonical/tdx](https://github.com/canonical/tdx)) with the modified qemu build

This allows the build process to not depend on the host's tooling

### Image preparation

Runs `mkosi.prepare.chroot`, which has network access, to download crate dependencies.

### Image building

Runs `mkosi.build.chroot` to produce the output

## Debug suggestions

- Adding `bash` to mkosi scripts to drop an interactive shell that lets you explore the build process
- Adding a root password in `mkosi.conf` to allow logging in to the container

## Running

You can enable the prover by setting `ETHREX_DEPLOYER_TDX_DEPLOY_VERIFIER=true` and running the sequencer in production mode (`ETHREX_PROOF_COORDINATOR_DEV_MODE=false`).

For development purposes, you can use the flag `ETHREX_TDX_DEV_MODE=true` to disable quote verification. This allows you to run the quote generator even without having TDX-capable hardware.

To run in production mode, ensure the proof coordinator is listening on 0.0.0.0 and run `mkosi vm -f`.

```
make init-l1
ETHREX_DEPLOYER_TDX_DEPLOY_VERIFIER=true make deploy-l1
ETHREX_PROOF_COORDINATOR_DEV_MODE=false PROOF_COORDINATOR_ADDRESS=0.0.0.0 make init-l2
cd tee
mkosi vm -f
```

## Troubleshooting

### RTMR/MRTD mismatch

If any code or dependencies changed, the measurements will change.

To obtain the new measurements, first you obtain the quote by running the prover (you don't need to have the l2 running). It's output will contain `Sending quote <very long hex string>`.

This usually causes a RTMR1 mismatch. The easiest way to obtain the new RTMR values is by looking at the printed quote for the next 96 bytes after the RTMR0, corresponding to RTMR1||RTMR2 (48 bytes each).

More generally, you can generate a report with DCAP.verifyAndAttestOnChain(quote) which validates and extracts the report.

Look at bytes 341..485 of the output for RTMRs and bytes 149..197 for the MRTD.

For example, the file `quote.example` contains a quote, which can be turned into the following report:

````
00048100000000b0c06f000000060103000000000000000000000000005b38e33a6487958b72c3c12a938eaa5e3fd4510c51aeeab58c7d5ecee41d7c436489d6c8e4f92f160b7cad34207b00c100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000e702060000000000

91eb2b44d141d4ece09f0c75c2c53d247a3c68edd7fafe8a3520c942a604a407de03ae6dc5f87f27428b2538873118b7 # MRTD

000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

4f3d617a1c89bd9a89ea146c15b04383b7db7318f41a851802bba8eace5a6cf71050e65f65fd50176e4f006764a42643 # RTMR0
53827a034d1e4c7f13fd2a12aee4497e7097f15a04794553e12fe73e2ffb8bd57585e771951115a13ec4d7e6bc193038 # RTMR1
2ca1a728ff13c36195ad95e8f725bf00d7f9c5d6ed730fb8f50cccad692ab81aefc83d594819375649be934022573528 # RTMR2
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 # RTMR3

39618efd10b14136ab416d6acfff8e36b23533a90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
```

name: run-assertoor-ethrex-only-test

on:
    pull_request:
      branches: ["**"]
    workflow_dispatch:
  
jobs:
    docker_build:
      name: Build Docker
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Build Docker image
          uses: docker/build-push-action@v6
          with:
            context: .
            file: ./Dockerfile
            load: true
            tags: ethrex
            outputs: type=docker,dest=/tmp/ethrex_image.tar

        - name: Upload artifacts
          uses: actions/upload-artifact@v4
          with:
            name: ethrex_image
            path: /tmp/ethrex_image.tar
    
    assertoor:
      name: Assertoor tests
      runs-on: ubuntu-latest
      steps:
          - name: Checkout Repository
            uses: actions/checkout@v4

          - name: Download etherex image artifact
            uses: actions/download-artifact@v4
            with:
              name: ethrex_image
              path: /tmp
      
          - name: Load image
            run: |
              docker load --input /tmp/ethrex_image.tar
            
          - name: Kurtosis Assertoor GitHub Action
            uses: ethpandaops/kurtosis-assertoor-github-action@v1
            with:
              ethereum_package_url: 'github.com/lambdaclass/ethereum-package'
              ethereum_package_branch: 'ethrex-integration-pectra'
              ethereum_package_args: ./.github/config/assertoor/network_params_ethrex_only.yaml

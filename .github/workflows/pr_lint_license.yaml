name: Check License

on:
  workflow_dispatch:
  pull_request:
    branches: ["**"]
    paths:
      - "**/Cargo.toml"
      - "LICENSE*"
      - ".github/workflows/pr_lint_license.yaml"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  check-license:
    name: Verify Dual License
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Check license files exist
        run: |
          if [ ! -f LICENSE-MIT ]; then
            echo "::error::LICENSE-MIT file is missing"
            exit 1
          fi
          if [ ! -f LICENSE-APACHE ]; then
            echo "::error::LICENSE-APACHE file is missing"
            exit 1
          fi
          echo "License files present: LICENSE-MIT, LICENSE-APACHE"

      - name: Check all packages have correct license
        run: |
          # Check main workspace
          echo "Checking main workspace packages..."
          MISSING=$(cargo metadata --format-version 1 --no-deps 2>/dev/null | \
            jq -r '.packages[] | select(.license != "MIT OR Apache-2.0") | .name')

          if [ -n "$MISSING" ]; then
            echo "::error::The following packages do not have 'MIT OR Apache-2.0' license:"
            echo "$MISSING"
            exit 1
          fi

          # Check tooling workspace
          echo "Checking tooling workspace packages..."
          cd tooling
          MISSING_TOOLING=$(cargo metadata --format-version 1 --no-deps 2>/dev/null | \
            jq -r '.packages[] | select(.license != "MIT OR Apache-2.0") | .name')

          if [ -n "$MISSING_TOOLING" ]; then
            echo "::error::The following tooling packages do not have 'MIT OR Apache-2.0' license:"
            echo "$MISSING_TOOLING"
            exit 1
          fi

          echo "All packages have correct 'MIT OR Apache-2.0' license"

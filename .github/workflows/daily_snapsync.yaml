name: Daily Snapsync Ethrex

on:
  pull_request:
    branches: ["**"]
    paths:
      - ".github/workflows/daily_snapsync.yaml"
  schedule:
    # Every day at UTC 03:00
    - cron: "0 3 * * 1,2,3,4,5"
  workflow_dispatch:
    inputs:
      network:
        description: "Network name (use 'all' to run both)"
        required: false
        default: "hoodi"
      timeout:
        description: "Assertoor test timeout"
        required: false
        default: "120m"
      minBlockHeight:
        description: "Minimum block height for progress check"
        required: false
        default: "10"
  workflow_call:
    inputs:
      network:
        description: "Network name"
        required: false
        default: "hoodi"
        type: string
      timeout:
        description: "Assertoor test timeout"
        required: false
        default: "120m"
        type: string
      minBlockHeight:
        description: "Minimum block height for progress check"
        required: false
        default: "10"
        type: string

permissions:
  contents: read

concurrency:
  group: ethrex-sync-server
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.targets.outputs.matrix }}
    steps:
      - id: targets
        run: |
          event_name="${GITHUB_EVENT_NAME}"
          if [[ "$event_name" == "schedule" ]]; then
            json='[{"network":"hoodi","timeout":"120m","minBlockHeight":"10"},{"network":"sepolia","timeout":"120m","minBlockHeight":"10"}]'
          elif [[ "$event_name" == "pull_request" ]]; then
            json='[{"network":"hoodi","timeout":"120m","minBlockHeight":"10"}]'
          else
            network=$(jq -r '.inputs.network // empty' "$GITHUB_EVENT_PATH")
            timeout=$(jq -r '.inputs.timeout // empty' "$GITHUB_EVENT_PATH")
            min_block_height=$(jq -r '.inputs.minBlockHeight // empty' "$GITHUB_EVENT_PATH")

            timeout=${timeout:-120m}
            min_block_height=${min_block_height:-10}

            if [[ -z "$network" || "$network" == "all" ]]; then
              json='[{"network":"hoodi","timeout":"'"$timeout"'","minBlockHeight":"'"$min_block_height"'"},{"network":"sepolia","timeout":"'"$timeout"'","minBlockHeight":"'"$min_block_height"'"}]'
            else
              json='[{"network":"'"$network"'","timeout":"'"$timeout"'","minBlockHeight":"'"$min_block_height"'"}]'
            fi
          fi
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  sync:
    needs: prepare
    name: Sync ${{ matrix.network }}
    runs-on: ethrex-sync
    strategy:
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Run Snapsync Test
        uses: ./.github/actions/snapsync-run
        with:
          network: ${{ matrix.network }}
          timeout: ${{ matrix.timeout }}
          minBlockHeight: ${{ matrix.minBlockHeight }}

name: Daily Snapsync Check

on:
  pull_request:
    branches: ["**"]
    paths:
      - ".github/workflows/daily_snapsync.yaml"
  schedule:
    # Every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      network:
        description: "Network name (hoodi or sepolia)"
        required: false
        default: "hoodi"
      build_profile:
        description: "Cargo build profile (release or release-with-debug-assertions)"
        required: false
        default: "release-with-debug-assertions"

permissions:
  contents: read

concurrency:
  group: ethrex-sync-server
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.targets.outputs.matrix }}
      build_profile: ${{ steps.build_opts.outputs.build_profile }}
    steps:
      - id: targets
        run: |
          event_name="${GITHUB_EVENT_NAME}"
          if [[ "$event_name" == "schedule" ]]; then
            json='[{"network":"hoodi","timeout":"1h"},{"network":"sepolia","timeout":"3h30m"}]'
          elif [[ "$event_name" == "pull_request" ]]; then
            json='[{"network":"hoodi","timeout":"1h"}]'
          else
            network=$(jq -r '.inputs.network // empty' "$GITHUB_EVENT_PATH")

            case "$network" in
              hoodi)
                json='[{"network":"hoodi","timeout":"1h"}]'
                ;;
              sepolia)
                json='[{"network":"sepolia","timeout":"3h30m"}]'
                ;;
              *)
                echo "::error::Unsupported network value '$network'. Allowed values: hoodi, sepolia."
                exit 1
                ;;
            esac
          fi
          echo "matrix=$json" >> "$GITHUB_OUTPUT"
      - id: build_opts
        run: |
          event_name="${GITHUB_EVENT_NAME}"
          # Default to release-with-debug-assertions for scheduled runs and PRs
          # Manual runs can specify a different profile
          if [[ "$event_name" == "workflow_dispatch" ]]; then
            profile=$(jq -r '.inputs.build_profile // "release-with-debug-assertions"' "$GITHUB_EVENT_PATH")
          else
            profile="release-with-debug-assertions"
          fi
          echo "build_profile=$profile" >> "$GITHUB_OUTPUT"

  sync-lighthouse:
    needs: prepare
    name: Sync ${{ matrix.network }} - Lighthouse
    runs-on: ethrex-sync
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set start timestamp
        id: start
        run: |
          echo "timestamp=$EPOCHSECONDS" >> "$GITHUB_OUTPUT"

      - name: Run Snapsync Test
        uses: ./.github/actions/snapsync-run
        id: snapsync
        with:
          network: ${{ matrix.network }}
          timeout: ${{ matrix.timeout }}
          cl_type: lighthouse
          cl_image: "sigp/lighthouse:v8.0.1"
          build_local: "true"
          build_profile: ${{ needs.prepare.outputs.build_profile }}

      - name: Post run on slack
        if: always()
        env:
          SLACK_WEBHOOK_URL_SUCCESS: ${{ secrets.ETHREX_NOTIFICATIONS_SLACK_WEBHOOK }}
          SLACK_WEBHOOK_URL_FAILURE: ${{ secrets.ETHREX_L1_SLACK_WEBHOOK }}
          REPO: ${{ github.repository }}
          NAME: "lighthouse-${{ matrix.network }}"
          OUTCOME: ${{ steps.snapsync.outcome }}
          HEAD_SHA: ${{ github.sha }}
          START_TIME: ${{ steps.start.outputs.timestamp }}
        run: |
          bash .github/scripts/notify_snapsync_run.sh

  sync-prysm:
    needs: prepare
    name: Sync ${{ matrix.network }} - Prysm
    runs-on: ethrex-sync
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set start timestamp
        id: start
        run: |
          echo "timestamp=$EPOCHSECONDS" >> "$GITHUB_OUTPUT"

      - name: Run Snapsync Test
        uses: ./.github/actions/snapsync-run
        id: snapsync
        with:
          network: ${{ matrix.network }}
          timeout: ${{ matrix.timeout }}
          cl_type: prysm
          cl_image: "gcr.io/offchainlabs/prysm/beacon-chain:v7.1.0"
          build_local: "true"
          build_profile: ${{ needs.prepare.outputs.build_profile }}

      - name: Post run on slack
        if: always()
        env:
          SLACK_WEBHOOK_URL_SUCCESS: ${{ secrets.ETHREX_NOTIFICATIONS_SLACK_WEBHOOK }}
          SLACK_WEBHOOK_URL_FAILURE: ${{ secrets.ETHREX_L1_SLACK_WEBHOOK }}
          REPO: ${{ github.repository }}
          NAME: "prysm-${{ matrix.network }}"
          OUTCOME: ${{ steps.snapsync.outcome }}
          HEAD_SHA: ${{ github.sha }}
          START_TIME: ${{ steps.start.outputs.timestamp }}
        run: |
          bash .github/scripts/notify_snapsync_run.sh

  # Fast unit tests for healing, recovery, and memory validation
  healing-unit-tests:
    name: Healing Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-healing-tests-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-healing-tests-

      - name: Run healing cache tests
        run: cargo test -p ethrex-p2p healing_tests -- --nocapture

      - name: Run memory validation tests
        run: cargo test -p ethrex-p2p memory_tests -- --nocapture

      - name: Run recovery tests
        run: cargo test -p ethrex-p2p recovery_tests -- --nocapture

      - name: Run healing benchmarks (validation only)
        run: cargo test -p ethrex-p2p healing_bench -- --nocapture

  # Criterion benchmarks with PR comparison
  healing-benchmarks:
    name: Healing Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-healing-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-healing-bench-

      - name: Run Criterion benchmarks
        run: cargo bench --bench healing_benchmark -- --noplot

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: healing-benchmark-results
          path: target/criterion
          retention-days: 7

name: Snapsync Test

on:
  pull_request:
    paths:
      - ".github/workflows/manual_snapsync_test.yaml"
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ethrex-sync-server
  cancel-in-progress: false

jobs:
  run-hoodi:
    name: Hoodi Sync Check
    runs-on: ethrex-sync
    steps:
      - uses: actions/checkout@v4

      # We need to run this step because kurtosis uses cached docker images but we want the latest ethrex image
      - name: Remove cached ethrex image
        run: docker image rm -f ghcr.io/lambdaclass/ethrex:main || true

      - name: Run assertoor
        uses: ethpandaops/kurtosis-assertoor-github-action@v1
        with:
          enclave_name: "ethrex-assertoor-hoodi"
          kurtosis_version: "1.10.2"
          ethereum_package_url: "github.com/ethpandaops/ethereum-package"
          ethereum_package_branch: "82e5a7178138d892c0c31c3839c89d53ffd42d9a"
          ethereum_package_args: ".github/config/assertoor/network_params_hoodi.yaml"

      - name: Summarize ethrex version
        if: ${{ always() }}
        run: |
          image="ghcr.io/lambdaclass/ethrex:main"
          version="$(docker run --rm "$image" --version 2>/dev/null || true)"
          {
            echo "### Ethrex Version"
            echo ""
            echo "- ${version:-unavailable}"
          } >> "${GITHUB_STEP_SUMMARY}"

# .github/workflows/set-pr-status.yml
name: Set PR Status to In Progress

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]

jobs:
  update-project-status:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PROJECT_PERSONAL_ACCESS_TOKEN }}
          script: |
            // ========== FUNCTIONS ==========

            async function getProject(org, number) {
              const res = await github.graphql(`
                query($org: String!) {
                  organization(login: $org) {
                    projectsV2(first: 100) {
                      nodes {
                        id
                        title
                        number
                      }
                    }
                  }
                }
              `, { org });
              const project = res.organization.projectsV2.nodes.find(p => p.number === number);
              if (!project) throw new Error(`Project #${number} not found in org ${org}`);
              return project;
            }

            async function findProjectItem(projectId, prNumber) {
              let hasNextPage = true;
              let after = null;

              while (hasNextPage) {
                const res = await github.graphql(`
                  query($projectId: ID!, $after: String) {
                    node(id: $projectId) {
                      ... on ProjectV2 {
                        items(first: 100, after: $after) {
                          pageInfo {
                            hasNextPage
                            endCursor
                          }
                          nodes {
                            id
                            content {
                              ... on PullRequest {
                                number
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                `, { projectId, after });

                const items = res.node.items.nodes;
                const found = items.find(i => i.content?.number === prNumber);
                if (found) return found;

                hasNextPage = res.node.items.pageInfo.hasNextPage;
                after = res.node.items.pageInfo.endCursor;
              }

              return null;
            }

            async function setProjectItemDateField(projectId, itemId, fieldName, dateValue) {
              const res = await github.graphql(`
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      fields(first: 100) {
                        nodes {
                          ... on ProjectV2Field {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              `, { projectId });

              const field = res.node.fields.nodes.find(f => f.name === fieldName);
              if (!field) throw new Error(`Field '${fieldName}' not found`);

              const date = dateValue.split("T")[0]; // "YYYY-MM-DD"

              await github.graphql(`
                mutation {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: "${projectId}",
                    itemId: "${itemId}",
                    fieldId: "${field.id}",
                    value: { date: "${date}" }
                  }) {
                    projectV2Item { id }
                  }
                }
              `);

              console.log(`Set date field '${fieldName}' to '${date}'.`);
            }

            async function setProjectItemStatus(projectId, itemId, fieldName, optionName) {
              const res = await github.graphql(`
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      fields(first: 100) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `, { projectId });

              const field = res.node.fields.nodes.find(f => f.name === fieldName);
              if (!field) throw new Error(`Field '${fieldName}' not found`);

              const option = field.options.find(opt => opt.name === optionName);
              if (!option) throw new Error(`Option '${optionName}' not found in field '${fieldName}'`);

              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item { id }
                  }
                }
              `, {
                projectId,
                itemId,
                fieldId: field.id,
                optionId: option.id
              });

              console.log(`Set status to '${optionName}' in field '${fieldName}'.`);
            }

            async function getProjectItemFieldValue(projectId, itemId, fieldName) {
              const res = await github.graphql(`
                query($projectId: ID!, $itemId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      fields(first: 100) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                  item: node(id: $itemId) {
                    ... on ProjectV2Item {
                      fieldValues(first: 100) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            field {
                              ... on ProjectV2SingleSelectField {
                                id
                                name
                              }
                            }
                            optionId
                            optionName: name
                          }
                        }
                      }
                    }
                  }
                }
              `, { projectId, itemId });

              const field = res.node.fields.nodes.find(f => f.name === fieldName);
              if (!field) throw new Error(`Field '${fieldName}' not found`);

              const fieldValue = res.item.fieldValues.nodes.find(fv => fv.field?.name === fieldName);
              if (!fieldValue) throw new Error(`No value set for field '${fieldName}'`);

              return fieldValue.optionName;
            }


            // ========== MAIN LOGIC ==========
            const pr = context.payload.pull_request;
            const projectNumber = 31;
            const statusFieldName = "Status";
            const lastUpdatedFieldName = "Last updated";
            const startDateFieldName = "Start date";
            const orgLogin = "lambdaclass";

            const body = pr.body || "";
            console.log(body);
            // Step 1: Remove all markdown/HTML comments
            const withoutComments = body.replace(/<!--[\s\S]*?-->/g, "");
            console.log("Body without comments");
            console.log(withoutComments);
            // Step 2: Match all issue-closing keywords outside comments
            const matches = [...withoutComments.matchAll(/(?:close[sd]?|fixe[sd]?|resolve[sd]?)\s+#(\d+)/gi)];
            // Step 3: Extract issue numbers
            const issueNumbers = matches.map(match => parseInt(match[1]));

            console.log(issueNumbers);

            // Get project and item representing Pull Request.
            const project = await getProject(orgLogin, projectNumber);
            const projectId = project.id;
            const pr_item = await findProjectItem(projectId, pr.number);
            if (!pr_item) {
              console.log(`PR #${pr.number} not found in project.`);
              return;
            }

            // Set Start date
            let opened = context.payload.action === "opened"; // This only happens once in each PR
            if (opened) {
              await setProjectItemDateField(projectId, pr_item.id, startDateFieldName, pr.created_at);
            }

            // Set date of Last update
            await setProjectItemDateField(projectId, pr_item.id, lastUpdatedFieldName, pr.updated_at);

            let current_status = await getProjectItemFieldValue(projectId, pr_item.id, statusFieldName);
            console.log(`Current status: ${current_status}`);

            if (current_status === "Approved" || current_status === "Requested Changes") {
              // If PR is approved we don't want to change it's state
              // If changes were requested we can't automatically tell if they are ready for review once again. This has to be manual.
              console.log(`Exiting workflow because of current PR status.`);
              return;
            }

            let is_draft = pr.draft;
            let ready_for_review = context.payload.action === "ready_for_review";

            // If PR is in draft it is "In Progress". Otherwise, if it was opened for review it's "In Review".
            if (is_draft) {
              await setProjectItemStatus(projectId, pr_item.id, statusFieldName, "In Progress");
            } else if (ready_for_review) {
              await setProjectItemStatus(projectId, pr_item.id, statusFieldName, "In Review");
            }

name: Build Guest Programs (ere-compiler)

on:
  workflow_call:
    inputs:
      ere_version:
        required: true
        type: string
        description: "ere-compiler version (e.g., 0.2.0-abcd123)"
      ref_name:
        required: true
        type: string
        description: "Git ref name for artifact naming"

env:
  # Work around frequent libgit2/submodule fetch flakiness in CI.
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"
  CARGO_NET_RETRY: "10"

jobs:
  build-guest-ere:
    strategy:
      matrix:
        zkvm:
          - sp1
          - risc0
          - zisk
        include:
          - zkvm: sp1
            sdk_version: v5_0_8
            arch: riscv32im
          - zkvm: risc0
            sdk_version: v3_0_3
            arch: riscv32im
          - zkvm: zisk
            sdk_version: v0_15_0
            arch: riscv64ima
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free Disk Space
        uses: ./.github/actions/free-disk

      - name: Get version info
        id: versions
        env:
          REF_NAME: ${{ inputs.ref_name }}
        run: |
          # Get ethrex version from tag (e.g., v8.0.0 -> v8_0_0)
          ETHREX_VERSION=$(echo "$REF_NAME" | sed 's/\./_/g' | tr -d 'v')
          echo "ethrex_version=v$ETHREX_VERSION" >> $GITHUB_OUTPUT

          # Artifact name following naming convention:
          # <EL_NAME>-<EL_VERSION>-<ZKVM_NAME>-<ZKVM_SDK_VERSION>
          ARTIFACT_NAME="ethrex-v${ETHREX_VERSION}-${{ matrix.zkvm }}-${{ matrix.sdk_version }}"
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Pull ere-compiler image
        env:
          ERE_VERSION: ${{ inputs.ere_version }}
        run: |
          docker pull ghcr.io/eth-act/ere/ere-compiler-${{ matrix.zkvm }}:$ERE_VERSION

      - name: Compile guest with ere-compiler
        env:
          ARTIFACT_NAME: ${{ steps.versions.outputs.artifact_name }}
          ERE_VERSION: ${{ inputs.ere_version }}
        run: |
          mkdir -p output
          docker run --rm \
            -v ${{ github.workspace }}:/workspace:ro \
            -v ${{ github.workspace }}/output:/output \
            ghcr.io/eth-act/ere/ere-compiler-${{ matrix.zkvm }}:$ERE_VERSION \
            --compiler-kind rust-customized \
            --guest-path /workspace/crates/guest-program/bin/${{ matrix.zkvm }} \
            --output-path /output/$ARTIFACT_NAME

      - name: Extract raw ELF (backwards compatibility)
        env:
          ARTIFACT_NAME: ${{ steps.versions.outputs.artifact_name }}
        run: |
          # ere Program format: bincode serialized struct with elf: Vec<u8> as first field
          # Format: 8 bytes (u64 LE length) + elf bytes + optional metadata
          python3 -c "
          import sys
          import struct
          import os

          artifact_name = os.environ['ARTIFACT_NAME']
          with open(f'output/{artifact_name}', 'rb') as f:
              data = f.read()

          # Read ELF length (first 8 bytes, little-endian u64)
          elf_len = struct.unpack('<Q', data[:8])[0]

          # Extract ELF bytes
          elf = data[8:8+elf_len]

          with open(f'output/{artifact_name}.elf', 'wb') as f:
              f.write(elf)

          print(f'Extracted ELF: {elf_len} bytes')
          "

      - name: Verify artifacts exist
        env:
          ARTIFACT_NAME: ${{ steps.versions.outputs.artifact_name }}
        run: |
          ls -la output/
          echo "ere Program size: $(stat -c%s "output/$ARTIFACT_NAME") bytes"
          echo "Raw ELF size: $(stat -c%s "output/$ARTIFACT_NAME.elf") bytes"

      - name: Upload ere Program artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.versions.outputs.artifact_name }}
          path: output/${{ steps.versions.outputs.artifact_name }}

      - name: Upload raw ELF artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.versions.outputs.artifact_name }}.elf
          path: output/${{ steps.versions.outputs.artifact_name }}.elf

name: Check L2 Genesis

on:
  pull_request:
    branches: ["**"]
    paths:
      - "crates/l2/contracts/src/**"
      - "cmd/ethrex/build.rs"
      - "cmd/ethrex/build_l2.rs"
      - "fixtures/genesis/l2.json"
      - "crates/common/types/genesis.rs"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  # Work around frequent libgit2/submodule fetch flakiness in CI.
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"
  CARGO_NET_RETRY: "10"

jobs:
  check-l2-genesis:
    name: Check L2 Genesis is up to date
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Setup Rust Environment
        uses: ./.github/actions/setup-rust

      - name: Install solc
        uses: ./.github/actions/install-solc

      - name: Compile deployer with contracts
        run: COMPILE_CONTRACTS=1 cargo build --release --features l2 --bin ethrex

      - name: Check for uncommitted changes to l2.json
        run: |
          if ! git diff --exit-code fixtures/genesis/l2.json; then
            echo ""
            echo "::error::fixtures/genesis/l2.json has uncommitted changes after contract compilation."
            echo "::error::Please run 'COMPILE_CONTRACTS=1 cargo build --release --features l2 --bin ethrex' locally and commit the updated l2.json file."
            exit 1
          fi
          echo "l2.json is up to date."

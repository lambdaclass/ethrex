name: PR Review - Kimi

on:
  pull_request:
    types: [ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  kimi-review:
    name: Kimi Code Review
    runs-on: ubuntu-latest
    env:
      PR_NUMBER: ${{ github.event.pull_request.number || github.event.inputs.pr_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ env.PR_NUMBER }} > pr_diff.txt
          # Truncate if too large (Kimi has context limits)
          head -c 100000 pr_diff.txt > pr_diff_truncated.txt

      - name: Kimi Code Review
        id: kimi_review
        env:
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$KIMI_API_KEY" ]; then
            echo "Error: KIMI_API_KEY secret is not set" > kimi_review.txt
            exit 0
          fi

          PR_TITLE=$(gh pr view ${{ env.PR_NUMBER }} --json title -q '.title')
          DIFF_CONTENT=$(cat pr_diff_truncated.txt)

          # Build the request body
          REQUEST_BODY=$(jq -n \
            --arg diff "$DIFF_CONTENT" \
            --arg title "$PR_TITLE" \
            '{
              "model": "moonshot-v1-128k",
              "messages": [
                {
                  "role": "system",
                  "content": "You are a senior code reviewer for ethrex, a Rust-based Ethereum execution client."
                },
                {
                  "role": "user",
                  "content": ("PR Title: " + $title + "\n\nReview this PR focusing on:\n- Code correctness and potential bugs\n- Security vulnerabilities (critical for blockchain code)\n- Performance implications\n- Rust best practices and idiomatic patterns\n- Memory safety and proper error handling\n- Code readability and maintainability\n\nEthereum-specific considerations:\n- EVM opcode correctness and gas accounting\n- Consensus rules and EIP compliance\n- State trie and storage operations\n- RLP encoding/decoding correctness\n- Transaction and block validation logic\n\nBe concise and specific. Provide line references when suggesting changes.\nIf the code looks good, acknowledge it briefly.\n\nDiff:\n" + $diff)
                }
              ],
              "temperature": 0.3,
              "max_tokens": 4096
            }')

          # Try the API call
          HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" https://api.moonshot.ai/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $KIMI_API_KEY" \
            -d "$REQUEST_BODY")

          HTTP_CODE=$(echo "$HTTP_RESPONSE" | tail -n1)
          RESPONSE=$(echo "$HTTP_RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" != "200" ]; then
            echo "API Error (HTTP $HTTP_CODE): $RESPONSE" > kimi_review.txt
          else
            # Check for API errors in response
            ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
            if [ -n "$ERROR" ]; then
              echo "API Error: $ERROR" > kimi_review.txt
            else
              REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "Error: Unexpected API response"')
              echo "$REVIEW" > kimi_review.txt
            fi
          fi

      - name: Post review comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_CONTENT=$(cat kimi_review.txt)

          gh pr comment ${{ env.PR_NUMBER }} --body "## Kimi AI Code Review

          $REVIEW_CONTENT

          ---
          *Automated review by Kimi (Moonshot AI)*"

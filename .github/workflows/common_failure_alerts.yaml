name: Workflow Failure Alerts

on:
  workflow_run:
    workflows:
      - L1
      - L2 (SP1 Backend)
      - L2 (without proving)
      - L2 Prover
      - L2 Prover (TDX)
      - L2 TDX build
      - LEVM
      - Publish Docker
      - Replay proving
    branches:
      - main
    types:
      - completed

permissions:
  contents: read

jobs:
  notify-on-failure:
    name: Notify Slack on failure (main)
    runs-on: ubuntu-latest
    if: >-
      ${{ github.event.workflow_run.conclusion != 'success' &&
          github.event.workflow_run.event == 'push' }}
    steps:
      - name: Select Slack webhook
        id: select_webhook
        run: |
          WF_NAME="${{ github.event.workflow_run.name }}"
          if echo "$WF_NAME" | grep -Eiq 'L2|Replay'; then
            echo "webhook=${{ secrets.ETHREX_L2_SLACK_WEBHOOK }}" >> "$GITHUB_OUTPUT"
          else
            echo "webhook=${{ secrets.ETHREX_L1_SLACK_WEBHOOK }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Post failure to Slack
        env:
          REPO: ${{ github.repository }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          RUN_HTML_URL: ${{ github.event.workflow_run.html_url }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          bash .github/scripts/notify_workflow_failure.sh "${{ steps.select_webhook.outputs.webhook }}"
